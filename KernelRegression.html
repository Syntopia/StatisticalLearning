<!--
Notice: this file contains code from other authors which may be covered by other copyrights:
1) The Ziggurat Normal Distribution is taken from https://www.filosophy.org/post/35/normaldistributed_random_values_in_javascript_using_the_ziggurat_algorithm/
//-->
<html>
<head>
<link href="https://fonts.googleapis.com/css?family=Cardo|Open+Sans:400,400i,600|Material+Icons" rel="stylesheet">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js" ></script>
<style>
html, body {
padding: 15px;
font: 750 32px/1.5em Cardo, Georgia, serif;

font-size: 21px;
} 

/* Bret Victor style 'Tangle' inspired links (http://worrydream.com/Tangle/) */

a:hover {
    color: #00f;
    border-color: #00f;
	text-decoration: none;
}

a { 
 border-bottom: 3px dotted #99f;
   padding: 0px 1px;
	 cursor: pointer;
	text-decoration: none;
}

/* The modal text box is based on code from: http://www.w3schools.com/howto/howto_css_modals.asp */

/* The Modal (background) */
.modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    padding-top: 100px; /* Location of the box */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
}


/* ------------------------------------------------------------------------------------------------------------------- */
/* all of this style code just styles the input slider (autogenerated from http://www.cssportal.com/style-input-range/) */
 
h1 {
  font: 400 32px/1.1em Cardo, Georgia, serif;
  /*-webkit-font-smoothing: antialiased;*/
}

h3 {
  font: 700 25px/1.1em Cardo, Georgia, serif;
  /*-webkit-font-smoothing: antialiased;*/
}

div, p{
  font-family: Cardo, Georgia, serif;
  /*-webkit-font-smoothing: antialiased;*/
}




input[type=range] {
  -webkit-appearance: none;
  margin: 0px 0;
  width: 100%;
}
input[type=range]:focus {
  outline: none;
}
input[type=range]::-webkit-slider-runnable-track {
  width: 100%;
  height: 1px;
  cursor: pointer;
  animate: 0.2s;
  box-shadow: 0px 0px 0px #858585;
  background: #3071A9;
  border-radius: 0px;
  border: 1px solid #878787;
}
input[type=range]::-webkit-slider-thumb {
  box-shadow: 1px 1px 1px #000000;
  border: 1px solid #000000;
  height: 16px;
  width: 16px;
  border-radius: 16px;
  background: #FFFFFF;
  cursor: pointer;
  -webkit-appearance: none;
  margin-top: -8.5px;
}
input[type=range]:focus::-webkit-slider-runnable-track {
  background: #3071A9;
}
input[type=range]::-moz-range-track {
  width: 100%;
  height: 1px;
  cursor: pointer;
  animate: 0.2s;
  box-shadow: 0px 0px 0px #858585;
  background: #3071A9;
  border-radius: 0px;
  border: 1px solid #878787;
}
input[type=range]::-moz-range-thumb {
  box-shadow: 1px 1px 1px #000000;
  border: 1px solid #000000;
  height: 16px;
  width: 16px;
  border-radius: 16px;
  background: #FFFFFF;
  cursor: pointer;
}
input[type=range]::-ms-track {
  width: 100%;
  height: 1px;
  cursor: pointer;
  animate: 0.2s;
  background: transparent;
  border-color: transparent;
  color: transparent;
}
input[type=range]::-ms-fill-lower {
  background: #3071A9;
  border: 1px solid #878787;
  border-radius: 0px;
  box-shadow: 0px 0px 0px #858585;
}
input[type=range]::-ms-fill-upper {
  background: #3071A9;
  border: 1px solid #878787;
  border-radius: 0px;
  box-shadow: 0px 0px 0px #858585;
}
input[type=range]::-ms-thumb {
  box-shadow: 1px 1px 1px #000000;
  border: 1px solid #000000;
  height: 16px;
  width: 16px;
  border-radius: 16px;
  background: #FFFFFF;
  cursor: pointer;
}
input[type=range]:focus::-ms-fill-lower {
  background: #3071A9;
}
input[type=range]:focus::-ms-fill-upper {
  background: #3071A9;
}

</style>
</head>
<body>
<h1>Regression in Kernel Space</h1>
<p><i>See Section 5.8 in ESL. Use Chrome!</i></p>
<canvas id="myCanvas" width="1000px" height="600px" style="width: 500px;height: 300px;"></canvas>
<div id="ui">

</div>

<div id="functionExamples" class="modal">
  <div class="modal-content">
    <h3>Select an example function:</h3>
	<p><a href="javascript:setFunction('x*2.0-1');">Line</a></p>
	<p><a href="javascript:setFunction('Math.sin(x*6.14)');">Sine</a></p>
	<p><a href="javascript:setFunction('4.0*Math.abs(x-0.5)-1.0');">Sawtooth</a></p>
	<p><a href="javascript:setFunction('13*x*x*x-11*x*x+0.5*x-0.1')">Degree 3 polynomial</a></p>
  	<p><a href="javascript:setFunction('Math.abs(x-0.5)>0.1 ? 0.5 : -0.5');">Square</a></p>
 </div>
</div>

<div id="kernelExamples" class="modal">
  <div class="modal-content">
    <h3>Select an example kernel:</h3>
	<p><a href="javascript:setKernel('x*y')">Linear</a></p>
	<p><a href="javascript:setKernel('Math.pow(x*y+1,5)')">Polynomial (degree = 5)</a></p>
	<p><a href="javascript:setKernel('Math.pow(x*y+1,30)')">Polynomial (degree = 30)</a></p>
	<p><a href="javascript:setKernel('Math.exp(-100*(x-y)*(x-y))')">Gaussian (&nu; = 100)</a></p>
 	<p><a href="javascript:setKernel('Math.exp(-1000*(x-y)*(x-y))')">Gaussian (&nu; = 1000)</a></p>
  	<p><a href="javascript:setKernel('Math.exp(-10*Math.abs(x-y))')">Laplacian (&alpha; = 10)</a></p>
  	<p><a href="javascript:setKernel('(x-y)*(x-y)*Math.log10(Math.abs(x-y)+0.0001)')">Spline (see 5.6.6)</a></p>
  </div>
</div>


<script>
var Settings = {};
Settings.uniform = false;
Settings.eigenfunctions = false;
Settings.run = false;

// -------------------------------------------------------------------------------------------------------------
// User interface
// -------------------------------------------------------------------------------------------------------------

function setFunction(expression, dontUpdate) {
	Settings.function = new Function("x", "return " + expression);
	var formula = document.getElementById("formula");
	formula.value = expression;
	functionDialog.style.display = "none";
	if (!dontUpdate) updateParameters();
}

function updateKernel() {
	var kernel = document.getElementById("kernel");
	try {
		Settings.kernel = new Function("x", "y", "return " + kernel.value);
		updateParameters();
		kernel.style.background = "#fff";
	} catch (ex) {
		kernel.style.background = "#f99";
		Settings.kernel = new Function("x", "y", "return 1");
	}
}

function updateFunction() {
	var formula = document.getElementById("formula");
	try {
		Settings.function = new Function("x", "return " + formula.value);
		updateParameters();
		formula.style.background = "#fff";
	} catch (ex) {
		formula.style.background = "#f99";
		Settings.function = new Function("x", "return 0");
	}
}	

function setKernel(expression, dontUpdate) {
	Settings.kernel = new Function("x", "y", "return " + expression);
	var kernel = document.getElementById("kernel");
	kernel.value = expression;
	kernelDialog.style.display = "none";
	if (!dontUpdate) updateParameters();
}

var kernelDialog = document.getElementById('kernelExamples');
var functionDialog = document.getElementById('functionExamples');

function showFunctionExamples() {
    functionDialog.style.display = "block";
}

function showKernelExamples() {
    kernelDialog.style.display = "block";
}

window.onclick = function(event) {
    if (event.target ==  functionDialog) {
        functionDialog.style.display = "none";
    }
	if (event.target ==  kernelDialog) {
        kernelDialog.style.display = "none";
    }
}

var ui = document.getElementById('ui');

function createSlider(container, name, label, defaultValue) {
	var html = "<div><span id='"+ name +"Label'>"+label+"&nbsp;&nbsp;</span>";
	html += "<input id='"+name+"Slider' value='"+defaultValue+ "' type='range' min='0' max='100' style='width: 300px;'>";
	html += "&nbsp;&nbsp;<span id='"+name+"Value'>"+defaultValue+"</span></div>";
	container.insertAdjacentHTML('beforeend', html);
	Settings[name] = defaultValue;
		
	var slider = document.getElementById(name+"Slider");
	var value = document.getElementById(name+"Value");
	slider.addEventListener('input', function() { 
	    Settings[name] = slider.value;
		value.innerHTML = slider.value;  
		if (Settings.run) { Settings.run = false; updateParameters(); Settings.run = true;  }
 		updateParameters();
		
	});
}  

function run() {
 var link = document.getElementById("run");
 if (Settings.run) {
	link.innerHTML = "Show variance";
	Settings.run = false;
 } else {
	link.innerHTML = "Stop";
	Settings.run = true;
 }
 window.requestAnimationFrame(updateParameters); 
}

function toggleDistribution() {
 var link = document.getElementById("distribution");
 if (Settings.uniform) {
	link.innerHTML = "Random";
	Settings.uniform = false;
 } else {
	link.innerHTML = "Uniform";
	Settings.uniform = true;
 }
 updateParameters(); 
}

function toggleEigenfunctions() {
	if (!Settings.uniform) toggleDistribution();
	Settings.eigenfunctions = true;
	updateParameters(); 
}

ui.insertAdjacentHTML('beforeend', "<h3>Function to sample</h3>");
ui.insertAdjacentHTML('beforeend', "<div>f(x)=<input onchange='updateFunction();' onkeypress='this.onchange();' onpaste='this.onchange();' oninput='this.onchange();' type='text' id='formula' value='Math.sin(x) + Math.sin(x * 2)'>&nbsp;<a class=toggle href='javascript:showFunctionExamples();' >Examples</a> </div>");
createSlider(ui, "Noise", "Noise level", 50);
createSlider(ui, "Samples", "Sample points", 20);
ui.insertAdjacentHTML('beforeend', "<div>Distribution: <a class=toggle href='javascript:toggleDistribution();' id='distribution'>Random</a></div>");
ui.insertAdjacentHTML('beforeend', "<h3>Kernel</h3>");
ui.insertAdjacentHTML('beforeend', "<div>K(x,y)=<input onchange='updateKernel();' onkeypress='this.onchange();' onpaste='this.onchange();' oninput='this.onchange();' type='text' id='kernel' value='Math.pow(x*y+1, 2)'>&nbsp;<a class=toggle href='javascript:showKernelExamples();' >Examples</a> </div>");
createSlider(ui, "Lambda", "Regularization (&#955;)", 50);
ui.insertAdjacentHTML('beforeend', "<div><a class=toggle id=eigen href='javascript:toggleEigenfunctions();' >Show kernel eigen-functions</a> </div>");
ui.insertAdjacentHTML('beforeend', "<div><a class=toggle id=run href='javascript:run();' >Show variance</a> </div>");

setFunction("Math.abs(x-0.5)>0.1 ? 0.5 : -0.5", true);
setKernel("Math.exp(-100*(x-y)*(x-y))", true);

var canvas = document.getElementById('myCanvas'),
    ctx = canvas.getContext('2d'),
    width = canvas.width,
    height = canvas.height,
	getY = function getY(range, y) {
		return height -  (y - range[2]) *  (height / (range[3] - range[2]));
	},
	getX = function getX(range, x) {
		return  (x - range[0]) *  (width / (range[1] - range[0]));
	},
	plot = function plot(fn, range, clear, color) {
		if (clear && !Settings.run) ctx.clearRect(0, 0, width, height);
        var widthScale = (width / (range[1] - range[0]));
        ctx.beginPath();
		ctx.moveTo(0, getY(range, fn(0)));
        for (var x = 0; x < width; x++) {
            ctx.lineTo(x, getY(range, fn((x / widthScale) - range[0])));
        }
	    ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.stroke(); 
    },
	scatterConnected = function plot(xs,ys, range, color) {
		var widthScale = (width / (range[1] - range[0]));
        ctx.beginPath();
		ctx.moveTo(getX(range, xs[0]), getY(range, ys[0]));
        for (var i = 0; i < xs.length; i++) {
			ctx.lineTo(getX(range, xs[i]), getY(range, ys[i]));
        }
	    ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.stroke(); 
    },
	scatter = function scatter(x,y, range) {
		var widthScale = (width / (range[1] - range[0])),
            heightScale = (height / (range[3] - range[2]));
        
       ctx.fillStyle = "#c82124"; //red
       for (var i = 0; i < x.length; i++) {
            var xv = (x[i] * widthScale) + range[0],
                yv =  height -(y[i] - range[2]) * heightScale;
            ctx.beginPath();
			ctx.arc(xv, yv, 8, 0, 2 * Math.PI, true);
			ctx.fill();
	    }
    };

// -------------------------------------------------------------------------------------------------------------
// Actual calculations
// -------------------------------------------------------------------------------------------------------------

	
function updateParameters() {
	if (Settings.Samples==0) Settings.Samples=1;
	
	var N = Number(Settings.Samples);
	var fun = Settings.function;
	var kernel = Settings.kernel;
	
	// Sample the function (with some added gaussian noise)
	var xs = new Array(N);
	var ys = new Array(N);
	for (var i = 0; i < N; i++) {
	   xs[i] = Settings.uniform ? i/N+ 0.5/N:  Math.random();
	   ys[i] = fun(xs[i])+rnd.nextGaussian()*0.004*Settings.Noise;
	}
	
	// Calculate kernel matrix (plus regularization)
	var lambda = Math.pow(Settings.Lambda/50.0,2);
	var K = numeric.rep([N,N],0); // create empty matrix
	for (var i = 0; i < N; i++)
		for (var j = i; j < N; j++)  {
			var v = kernel(xs[i],xs[j]);
			K[i][j]=v;
			K[j][i]=v;
		}
		
	var lambdaMatrix = numeric.mul(numeric.identity(N), lambda);
	
	// inv(K+lambda*I)*y (Formula 5.55)
	var alpha = numeric.dot(numeric.inv(numeric.add(K,lambdaMatrix)), ys);
	
	// Calculate fitted function
	var fittedFun = function (x) {
		var sum = 0;
		for (var i = 0; i < N; i++) {
			sum+= alpha[i]*kernel(xs[i],x);
		}
		return sum;
	};
	
	plot(fun, [0, 1,  -1, 1], true, "grey");
	plot(fittedFun, [0, 1,  -1, 1], false, Settings.run ? "rgba(0,0,0,0.05)" : "green");
	if (!Settings.run) scatter(xs,ys, [0, 1,  -1, 1]);
	
	if (Settings.eigenfunctions) {
		var eigen = numeric.eig(K);
		for (var i = 0; i<5 && i<N; i++) {
			var es = new Array(N);
			for (var j = 0; j < N; j++) {
				es[j] = 0.5*eigen.E.x[j][i]*Math.abs(eigen.lambda.x[i]);
			}
			scatterConnected(xs,es, [0, 1,  -1, 1], "rgba(0,0,0,"+(1.0-i/5)+")");
		}
		Settings.eigenfunctions = false;
	}
	
	if (Settings.run) window.requestAnimationFrame(updateParameters); 
}  


// -------------------------------------------------------------------------------------------------------------
// Normal distribution using Ziggurat method. Taken from:
// https://www.filosophy.org/post/35/normaldistributed_random_values_in_javascript_using_the_ziggurat_algorithm/
// -------------------------------------------------------------------------------------------------------------

function Ziggurat(){

  var jsr = 123456789;

  var wn = Array(128);
  var fn = Array(128);
  var kn = Array(128);

  function RNOR(){
    var hz = SHR3();
    var iz = hz & 127;
    return (Math.abs(hz) < kn[iz]) ? hz * wn[iz] : nfix(hz, iz);
  }

  this.nextGaussian = function(){
    return RNOR();
  }

  function nfix(hz, iz){
    var r = 3.442619855899;
    var r1 = 1.0 / r;
    var x;
    var y;
    while(true){
      x = hz * wn[iz];
      if( iz == 0 ){
        x = (-Math.log(UNI()) * r1); 
        y = -Math.log(UNI());
        while( y + y < x * x){
          x = (-Math.log(UNI()) * r1); 
          y = -Math.log(UNI());
        }
        return ( hz > 0 ) ? r+x : -r-x;
      }

      if( fn[iz] + UNI() * (fn[iz-1] - fn[iz]) < Math.exp(-0.5 * x * x) ){
         return x;
      }
      hz = SHR3();
      iz = hz & 127;
 
      if( Math.abs(hz) < kn[iz]){
        return (hz * wn[iz]);
      }
    }
  }

  function SHR3(){
    var jz = jsr;
    var jzr = jsr;
    jzr ^= (jzr << 13);
    jzr ^= (jzr >>> 17);
    jzr ^= (jzr << 5);
    jsr = jzr;
    return (jz+jzr) | 0;
  }

  function UNI(){
    return 0.5 * (1 + SHR3() / -Math.pow(2,31));
  }

  function zigset(){
    // seed generator based on current time
    jsr ^= new Date().getTime();

    var m1 = 2147483648.0;
    var dn = 3.442619855899;
    var tn = dn;
    var vn = 9.91256303526217e-3;
    
    var q = vn / Math.exp(-0.5 * dn * dn);
    kn[0] = Math.floor((dn/q)*m1);
    kn[1] = 0;

    wn[0] = q / m1;
    wn[127] = dn / m1;

    fn[0] = 1.0;
    fn[127] = Math.exp(-0.5 * dn * dn);

    for(var i = 126; i >= 1; i--){
      dn = Math.sqrt(-2.0 * Math.log( vn / dn + Math.exp( -0.5 * dn * dn)));
      kn[i+1] = Math.floor((dn/tn)*m1);
      tn = dn;
      fn[i] = Math.exp(-0.5 * dn * dn);
      wn[i] = dn / m1;
    }
  }
  zigset();
}

var rnd = new Ziggurat();
updateParameters();


</script>

</body>
</html>